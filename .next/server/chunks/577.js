"use strict";exports.id=577,exports.ids=[577],exports.modules={549:(e,t,a)=>{a.d(t,{cn:()=>s});var n=a(82281),r=a(94805);function s(...e){return(0,r.QP)((0,n.$)(e))}},75721:(e,t,a)=>{a.d(t,{N:()=>g});var n=a(62211),r=a(16500);let s={winner:{include:{user:!0}},players:{include:{user:!0}}};async function i(e){let t=await n.z.game.findMany({where:e,include:s});return t.map(e=>e.players.map(e=>e.user)),t.map(w)}async function u(e,t){return w(await n.z.game.update({where:{id:e},data:{players:{create:{userId:t.id,index:1}},status:"inProgress"},include:s}))}async function l(e){let t=await n.z.game.findFirst({where:e,include:s});if(t)return w(t)}async function d(e){return w(await n.z.game.create({data:{status:e.status,id:e.id,field:e.field,players:{create:{index:0,userId:e.creator.id}}},include:s}))}async function c(e){let t="gameOver"===e.status?await n.z.gamePlayer.findFirstOrThrow({where:{userId:e.winner.id}}).then(e=>e.id):null;return w(await n.z.game.update({where:{id:e.id},data:{status:e.status,field:e.field,winnerId:t},include:s}))}let o=r.z.array(r.z.union([r.z.string(),r.z.null()]));function w(e){let t=e.players?e.players.sort((e,t)=>e.index-t.index).map(h):[];switch(e.status){case"idle":{let[a]=t;if(!a)throw Error("creator shoud be in game idle");return{id:e.id,creator:a,status:e.status,field:o.parse(e.field)}}case"inProgress":case"gameOverDraw":return{id:e.id,players:t,status:e.status,field:o.parse(e.field)};case"gameOver":if(!e.winner)throw Error("winner shoud be in game over");return{id:e.id,players:t,status:e.status,field:o.parse(e.field),winner:h(e.winner)}}}let h=e=>({id:e.user.id,login:e.user.login,rating:e.user.rating}),g={gamesList:i,createGame:d,getGame:l,startGame:u,saveGame:c}},25688:(e,t,a)=>{a.d(t,{N:()=>g});var n=a(22646),r=a(30379);let s={winner:{include:{user:!0}},players:{include:{user:!0}}};async function i(e){let t=await n.z.game.findMany({where:e,include:s});return t.map(e=>e.players.map(e=>e.user)),t.map(w)}async function u(e,t){return w(await n.z.game.update({where:{id:e},data:{players:{create:{userId:t.id,index:1}},status:"inProgress"},include:s}))}async function l(e){let t=await n.z.game.findFirst({where:e,include:s});if(t)return w(t)}async function d(e){return w(await n.z.game.create({data:{status:e.status,id:e.id,field:e.field,players:{create:{index:0,userId:e.creator.id}}},include:s}))}async function c(e){let t="gameOver"===e.status?await n.z.gamePlayer.findFirstOrThrow({where:{userId:e.winner.id}}).then(e=>e.id):null;return w(await n.z.game.update({where:{id:e.id},data:{status:e.status,field:e.field,winnerId:t},include:s}))}let o=r.z.array(r.z.union([r.z.string(),r.z.null()]));function w(e){let t=e.players?e.players.sort((e,t)=>e.index-t.index).map(h):[];switch(e.status){case"idle":{let[a]=t;if(!a)throw Error("creator shoud be in game idle");return{id:e.id,creator:a,status:e.status,field:o.parse(e.field)}}case"inProgress":case"gameOverDraw":return{id:e.id,players:t,status:e.status,field:o.parse(e.field)};case"gameOver":if(!e.winner)throw Error("winner shoud be in game over");return{id:e.id,players:t,status:e.status,field:o.parse(e.field),winner:h(e.winner)}}}let h=e=>({id:e.user.id,login:e.user.login,rating:e.user.rating}),g={gamesList:i,createGame:d,getGame:l,startGame:u,saveGame:c}},47085:(e,t,a)=>{a.d(t,{eq:()=>r,zj:()=>i,Bt:()=>l});var n=a(25688);async function r(){return await n.N.gamesList({status:"idle"})}a(64104);var s=a(82077);async function i(e,t){let a=await n.N.getGame({id:e});return a?"idle"!==a.status?(0,s.kb)("game-status-not-idle"):a.creator.id===t.id?(0,s.kb)("creator-can-not-start-game"):(0,s.pG)(await n.N.startGame(e,t)):(0,s.kb)("game-not-found")}var u=a(37404);async function l(e,t){let a=await n.N.getGame({id:e});if(!a)return(0,s.kb)("game-not-found");if("inProgress"!==a.status)return(0,s.kb)("game-is-not-in-progress");if(!a.players.some(e=>e.id===t.id))return(0,s.kb)("player-is-not-in-game");let r=await n.N.saveGame({...a,status:"gameOver",winner:a.players.find(e=>e.id!==t.id)});return await u.u.emit(a),(0,s.pG)(r)}},63954:(e,t,a)=>{a.d(t,{kg:()=>w,HW:()=>z,mB:()=>b,FH:()=>x});var n=a(71010),r=a(62211);let s={saveUser:function(e){return r.z.user.upsert({where:{id:e.id},create:e,update:e})},getUser:function(e){return r.z.user.findFirst({where:e})}};var i=a(21721),u=a.n(i);let l=(e,t)=>({id:e.id,login:e.login,expiredAt:t});var d=a(77598);async function c(e,t=(0,d.randomBytes)(16).toString("hex")){return{hash:(await new Promise((a,n)=>(0,d.pbkdf2)(e,t,1e3,64,"sha512",(e,t)=>e?n(e):a(t)))).toString("hex"),salt:t}}let o={comparePasswords:async function({hash:e,password:t,salt:a}){return e===(await c(t,a)).hash},hashPassword:c},w=async({login:e,password:t})=>{if(await s.getUser({login:e}))return(0,n.kb)("user-login-exists");let{hash:a,salt:r}=await o.hashPassword(t),i=await s.saveUser({id:u()(),login:e,rating:1e3,passwordHash:a,salt:r});return(0,n.pG)(i)};var h=a(83814),g=a(83160),f=a(99184),m=a(42385);let p=process.env.SESSION_SECRET,y=new TextEncoder().encode(p);async function v(e){return new h.P(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(y)}async function S(e=""){try{let{payload:t}=await (0,g.V)(e,y,{algorithms:["HS256"]});return(0,n.pG)(t)}catch(e){return(0,n.kb)(e)}}let E=()=>(0,m.UL)().then(e=>e.get("session")?.value),b={addSession:async function(e){if(!process.env.SESSION_SECRET)throw Error("SESSION_SECRET is not defined in .env");let t=new Date(Date.now()+6048e5),a=l(e,t.toISOString()),n=await v(a);(await (0,m.UL)()).set("session",n,{httpOnly:!0,secure:!0,expires:t,sameSite:"lax",path:"/"})},deleteSession:async function(){(await (0,m.UL)()).delete("session")},verifySession:async(e=E)=>{let t=await e(),a=await S(t);return"left"===a.type&&(0,f.redirect)("/sign-in"),{isAuth:!0,session:a.value}}};async function x({login:e,password:t}){let a=await s.getUser({login:e});return a&&await o.comparePasswords({hash:a.passwordHash,salt:a.salt,password:t})?(0,n.pG)(a):(0,n.kb)("login-or-password-incorrect")}let z=async()=>{let{session:e}=await b.verifySession();return s.getUser({id:e.id})}},33655:(e,t,a)=>{a.d(t,{HW:()=>p,mB:()=>m});var n=a(22646);let r={getUser:function(e){return n.z.user.findFirst({where:e})}};a(64104),a(77598);var s=a(95164),i=a(45997);let u=(e,t)=>({id:e.id,login:e.login,expiredAt:t});var l=a(82077),d=a(31831),c=a(44512);let o=process.env.SESSION_SECRET,w=new TextEncoder().encode(o);async function h(e){return new s.P(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(w)}async function g(e=""){try{let{payload:t}=await (0,i.V)(e,w,{algorithms:["HS256"]});return(0,l.pG)(t)}catch(e){return(0,l.kb)(e)}}let f=()=>(0,c.UL)().then(e=>e.get("session")?.value),m={addSession:async function(e){if(!process.env.SESSION_SECRET)throw Error("SESSION_SECRET is not defined in .env");let t=new Date(Date.now()+6048e5),a=u(e,t.toISOString()),n=await h(a);(await (0,c.UL)()).set("session",n,{httpOnly:!0,secure:!0,expires:t,sameSite:"lax",path:"/"})},deleteSession:async function(){(await (0,c.UL)()).delete("session")},verifySession:async(e=f)=>{let t=await e(),a=await g(t);return"left"===a.type&&(0,d.redirect)("/sign-in"),{isAuth:!0,session:a.value}}},p=async()=>{let{session:e}=await m.verifySession();return r.getUser({id:e.id})}},21476:(e,t,a)=>{let n;a.d(t,{u:()=>u});var r=a(13730);class s{constructor(e){this.channelName=e}async createChannel(){n||(n=await r.connect(process.env.MB_URL));let e=await n.createChannel();return await e.assertExchange(this.channelName,"direct",{durable:!1}),e}async emit(e,t){(await this.createChannel()).publish(this.channelName,e,Buffer.from(JSON.stringify({...t,date:new Date})))}async concume(e,t){let a=await this.createChannel(),n=await a.assertQueue("",{exclusive:!0});await a.bindQueue(n.queue,this.channelName,e);let r=await a.consume(n.queue,async e=>{await t(JSON.parse(e.content.toString())),a.ack(e)});return()=>{a.cancel(r.consumerTag)}}}class i{async addListener(e,t){return this.eventsChanel.concume(e,e=>{t(e)})}emit(e){return this.eventsChanel.emit(e.id,{type:"game-changed",data:e})}constructor(){this.eventsChanel=new s("game")}}let u=new i},37404:(e,t,a)=>{let n;a.d(t,{u:()=>u});var r=a(67549);class s{constructor(e){this.channelName=e}async createChannel(){n||(n=await r.connect(process.env.MB_URL));let e=await n.createChannel();return await e.assertExchange(this.channelName,"direct",{durable:!1}),e}async emit(e,t){(await this.createChannel()).publish(this.channelName,e,Buffer.from(JSON.stringify({...t,date:new Date})))}async concume(e,t){let a=await this.createChannel(),n=await a.assertQueue("",{exclusive:!0});await a.bindQueue(n.queue,this.channelName,e);let r=await a.consume(n.queue,async e=>{await t(JSON.parse(e.content.toString())),a.ack(e)});return()=>{a.cancel(r.consumerTag)}}}class i{async addListener(e,t){return this.eventsChanel.concume(e,e=>{t(e)})}emit(e){return this.eventsChanel.emit(e.id,{type:"game-changed",data:e})}constructor(){this.eventsChanel=new s("game")}}let u=new i},62211:(e,t,a)=>{a.d(t,{z:()=>r});var n=a(96330);let r=globalThis.prismaGlobal??new n.PrismaClient},22646:(e,t,a)=>{a.d(t,{z:()=>r});var n=a(96330);let r=globalThis.prismaGlobal??new n.PrismaClient},71010:(e,t,a)=>{a.d(t,{kb:()=>n,pG:()=>r});let n=e=>({error:e,type:"left"}),r=e=>({type:"right",value:e})},82077:(e,t,a)=>{a.d(t,{kb:()=>n,pB:()=>s,pG:()=>r});let n=e=>({error:e,type:"left"}),r=e=>({type:"right",value:e}),s=(e,t)=>"left"===e.type?t.left(e.error):t.right(e.value)}};